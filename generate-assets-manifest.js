#!/usr/bin/env node
/**
 * Asset Manifest Generator
 * 
 * Scans the ./assets directory for all .png files and generates a TypeScript
 * manifest file (src/assets-manifest.ts) that exports an array of asset keys.
 * 
 * This script should be run before building the project to ensure all assets
 * are automatically loaded without manual updates to BootScene.ts.
 */

import { readdir, writeFile } from 'fs/promises';
import { join, basename, extname } from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const ASSETS_DIR = join(__dirname, 'assets');
const OUTPUT_FILE = join(__dirname, 'src', 'assets-manifest.ts');

/**
 * Recursively scan directory for PNG files
 */
async function findPngFiles(dir) {
    const entries = await readdir(dir, { withFileTypes: true });
    const files = [];
    
    for (const entry of entries) {
        const fullPath = join(dir, entry.name);
        if (entry.isDirectory()) {
            // Recursively scan subdirectories
            const subFiles = await findPngFiles(fullPath);
            files.push(...subFiles);
        } else if (entry.isFile() && extname(entry.name).toLowerCase() === '.png') {
            // Get relative path from assets directory
            const relativePath = fullPath.substring(ASSETS_DIR.length + 1);
            files.push(relativePath);
        }
    }
    
    return files;
}

/**
 * Generate TypeScript manifest file
 */
async function generateManifest() {
    try {
        console.log('Scanning assets directory for PNG files...');
        const pngFiles = await findPngFiles(ASSETS_DIR);
        
        if (pngFiles.length === 0) {
            console.warn('Warning: No PNG files found in assets directory');
        }
        
        // Sort alphabetically for consistency
        pngFiles.sort();
        
        console.log(`Found ${pngFiles.length} PNG file(s)`);
        
        // Generate asset keys (basename without .png extension)
        const assetKeys = pngFiles.map(file => {
            const key = basename(file, '.png');
            return key;
        });
        
        // Generate TypeScript content
        const tsContent = `/**
 * Auto-generated asset manifest
 * 
 * This file is automatically generated by generate-assets-manifest.js
 * DO NOT EDIT MANUALLY - any changes will be overwritten
 * 
 * Generated: ${new Date().toISOString()}
 */

/**
 * Array of all PNG asset keys found in the assets directory
 * Each key corresponds to a .png file: {key}.png
 */
export const ASSET_KEYS: readonly string[] = [
${assetKeys.map(key => `    '${key}'`).join(',\n')}
] as const;

/**
 * Asset key type for type-safe asset references
 */
export type AssetKey = typeof ASSET_KEYS[number];
`;
        
        await writeFile(OUTPUT_FILE, tsContent, 'utf8');
        
        console.log(`✓ Generated manifest: ${OUTPUT_FILE}`);
        console.log(`✓ Exported ${assetKeys.length} asset key(s)`);
        
        // Log all asset keys for verification
        console.log('\nAsset keys:');
        assetKeys.forEach(key => console.log(`  - ${key}`));
        
    } catch (error) {
        console.error('Error generating asset manifest:', error);
        process.exit(1);
    }
}

// Run the generator
generateManifest();
